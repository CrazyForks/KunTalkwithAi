<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <!-- 严格 CSP：仅本地 asset 与内联（用于简化，无外链） -->
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'none'; img-src 'self' data:; style-src 'self' 'unsafe-inline' data:; script-src 'self' 'unsafe-inline' 'wasm-unsafe-eval'; font-src 'self' data:; connect-src 'none'; media-src 'none'; object-src 'none'; base-uri 'none'; frame-ancestors 'none'">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>KaTeX Renderer (Local)</title>

  <!-- 若后续加入本地 KaTeX 资源，请放到同目录并解除注释： -->
  <link rel="stylesheet" href="katex.min.css" />
  <script defer src="katex.min.js"></script>
 
  <style>
    :root {
      --bg: transparent;
      --fg: #1b1b1b;
      --muted: #666;

      /* 公式块外观（浅色） */
      --math-bg: transparent;      /* 默认跟随外层背景：透明 */
      --math-radius: 8px;
      --math-padding-v: 6px;
      --math-padding-h: 8px;
    }
    html.dark {
      --bg: transparent;
      --fg: #e9e9e9;
      --muted: #aaa;

      /* 公式块外观（深色） */
      --math-bg: transparent;      /* 若想有卡片效果，可改为 rgba(255,255,255,0.06) */
      --math-radius: 8px;
      --math-padding-v: 6px;
      --math-padding-h: 8px;
    }
    html, body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--fg);
      font-size: 16px;
      line-height: 1.3;
      -webkit-text-size-adjust: 100%;
      overflow: hidden; /* 由外层控制尺寸与滚动 */
    }
    #root {
      display: inline-block; /* 既支持 inline 也支持 block */
      color: var(--fg);
    }
    .fallback {
      white-space: pre-wrap;
      word-break: break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.95em;
      color: var(--muted);
      background: var(--math-bg);               /* 跟随主题变量（默认透明） */
      border-radius: var(--math-radius);
      padding: var(--math-padding-v) var(--math-padding-h);
      display: inline-block;
      vertical-align: baseline;
    }
    /* KaTeX 容器常用微调（当 katex.css 存在时补充对齐） */
    .katex-display {
      margin: 0 !important;
      background: var(--math-bg);               /* 跟随主题变量（默认透明） */
      border-radius: var(--math-radius);
      padding: var(--math-padding-v) var(--math-padding-h);
    }
  </style>
</head>
<body>
  <div id="root" aria-live="polite"></div>

  <script>
    (function () {
      const root = document.getElementById('root');

      function setTheme(theme) {
        const dark = theme === 'dark';
        document.documentElement.classList.toggle('dark', dark);
      }

      // 渲染入口：由 Compose 端 evaluateJavascript 调用
      // 返回 'ok' / 'err' / 'no'
      window.renderLatex = function (latex, inline, theme) {
        try {
          setTheme(theme === 'dark' ? 'dark' : 'light');
          // 清空
          while (root.firstChild) root.removeChild(root.firstChild);

          // 如果存在 KaTeX 则渲染，否则退回
          if (window.katex && typeof window.katex.render === 'function') {
            const span = document.createElement('span');
            root.appendChild(span);
            window.katex.render(latex, span, {
              displayMode: !inline,
              throwOnError: false,
              trust: false,
              strict: "warn", // 兼容尽量放宽但不抛异常
              output: "htmlAndMathml"
            });
            return 'ok';
          } else {
            // 无 KaTeX 资源：展示原文
            const pre = document.createElement('pre');
            pre.className = 'fallback';
            pre.textContent = latex;
            root.appendChild(pre);
            return 'err';
          }
        } catch (e) {
          // 渲染异常：展示原文
          try {
            const pre = document.createElement('pre');
            pre.className = 'fallback';
            pre.textContent = latex;
            root.appendChild(pre);
          } catch (_) {}
          return 'err';
        }
      };

      // 供宿主探测（未直接使用，但可扩展）
      window.__READY__ = true;
    })();
  </script>
</body>
</html>